include:
  - project: 'QubesOS/qubes-continuous-integration'
    file: '/r4.0/gitlab-base.yml'
  - project: 'QubesOS/qubes-continuous-integration'
    file: '/r4.0/gitlab-dom0.yml'

checks:pylint:
  stage: checks
  before_script:
    - git clone https://github.com/QubesOS/qubes-core-qrexec ~/qubes-core-qrexec
    - pip3 install --quiet -r ci/requirements.txt
  script:
    - PYTHONPATH=test-packages:~/qubes-core-qrexec pylint-3 qubes

checks:tests:
  image: fedora:32
  stage: checks
  tags:
    - short-living-job
    - docker
  before_script:
    # vim-common for xxd
    - dnf update -y vim-minimal
    - dnf install -y lvm2 vim-common python3-lxml python3-docutils python3-gobject gtk3 xorg-x11-server-Xvfb git python3-pip btrfs-progs diffutils python3-codecov e2fsprogs
    - git clone https://github.com/QubesOS/qubes-core-qrexec ~/qubes-core-qrexec
    - pip3 install --user -r ci/requirements.txt
  script:
    - PYTHONPATH=test-packages:~/qubes-core-qrexec xvfb-run ./run-tests
  after_script:
    - ci/codecov-wrapper -F unittests
